name: deploy using canary strategy
apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow

on:
  workflow_call:
    inputs:
      release-name:
        description: Helm release name
        type: string
        required: true
      namespace:
        description: Kubernetes namespace to install the chart in, created if missing
        type: string
        default: default
      version:
        description: Version of the chart to be installed
        type: string
      values-files:
        description: List of values files relative to the workspace separated by newline
        type: string
      values:
        description: An inline YAML representation of a values file passed to the Helm command
        type: string
      timeout:
        description: |
          Helm chart installation timeout.
          However, `Deployment.spec.progressDeadlineSeconds` takes precedence if it is defined with a lower value within the charts manifests.
        type: string
        default: 10m
      chart-location:
        description: >
          Helm chart location, can be a URL, a local chart archive,
          chart repo alias/chart name or an unpacked chart directory
        type: string
        required: true
      max-history:
        description: MaxHistory limits the maximum number of revisions saved per release
        type: number
        default: 10
      debug:
        description: Execute the helm command in debug mode
        type: boolean
        default: false
      dependency-build:
        description: Build dependencies based on the contents of Chart.lock file
        type: boolean
        default: false
      env-vars-file:
        description: >
          An optional file with key value pairs of the format export key=value
          to export in the environment before execution of the helm commands.
        type: string
      dry-run:
        description: Simulate an upgrade, without actually doing it
        type: boolean
        default: false
      registry-configuration:
        description: >
          CloudBees registry configuration file containing the registries to use for loading images.
          By default it uses the file containing the registries configured under Integrations' in the CloudBees platform.
        type: string
        #default: ${{ cloudbees.registries }}
        
jobs:
  deploy:
    permissions:
      scm-token-own: read
      id-token: write
    env:
      CHART_LOCATION: ${{ inputs.chart-location }}
      CHART_VERSION: ${{ inputs.version }}
      RELEASE_NAME: ${{ inputs.release-name }}
      VALUES_FILES: ${{ inputs.values-files }}
      VALUES_INLINE: ${{ inputs.values }}
      ENV_FILE: ${{ inputs.env-vars-file }}
      BUILD_DEPENDENCIES: ${{ inputs.dependency-build }}
      TIMEOUT: ${{ inputs.timeout }}
      HELM_NAMESPACE: ${{ inputs.namespace }}
      HELM_MAX_HISTORY: ${{ inputs.max-history }}
      HELM_DEBUG: ${{ inputs.debug == 'true' && 'true' || 'false' }}
      CLOUDBEES_REGISTRIES_CONFIG: ${{ inputs.registry-configuration }}
    steps:
    - name: Login to AWS
      uses: https://github.com/cloudbees-io/configure-aws-credentials@v1
      with:
        aws-region: us-east-1
        role-to-assume: arn:aws:iam::020229604682:role/cloudbees-infra-mgmt
        role-duration-seconds: "3600"
    - uses: cloudbees-io/configure-eks-credentials@v1
      with:
        name: eks-preprod-us-east-1  
    - name: Deploy Helm chart
      uses: cloudbees-io/helm-install@argo-rollout
      with:
        release-name: ${{ inputs.release-name }}
        namespace: ${{ inputs.namespace }}
        version: ${{ inputs.version }}
        values-files: ${{ inputs.values-files }}
        values: ${{ inputs.values }}
        timeout: ${{ inputs.timeout }}
        chart-location: ${{ steps.get-helm-chart.outputs.chart-location }}
        max-history: ${{ inputs.max-history }}
        debug: ${{ inputs.debug }}
        dependency-build: ${{ inputs.dependency-build }}
        env-vars-file: ${{ inputs.env-vars-file }}
        wait: true
        dry-run: ${{ inputs.dry-run }}
        registry-configuration: ${{ inputs.registry-configuration }}
