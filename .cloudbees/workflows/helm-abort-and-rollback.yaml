name: abort and rollback
apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow
on:
  workflow_call:
    inputs:
      helm-release:
        description: Helm release name
        type: string
        required: true
      artifact-id:
        description: artifact version to be installed
        type: string
      environment:
        description: Environment name to deploy on
        type: string
        required: true
        default: prod
      k8s-namespace:
        description: Kubernetes namespace to install the chart in, created if missing
        type: string
        default: default
      k8s-cluster:
        description: Kubernetes cluster to install the chart in
        type: string
        required: true
      aws-region:
        type: string
        required: true
      aws-role-to-assume:
        type: string
        required: true
jobs:
  abort-deployment:
    permissions:
      scm-token-own: read
      id-token: write
    steps:
      - name: Login to AWS
        uses: https://github.com/cloudbees-io/configure-aws-credentials@v1
        with:
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ inputs.aws-role-to-assume }}
          role-duration-seconds: "3600"
      - uses: cloudbees-io/configure-eks-credentials@v1
        with:
          name: ${{ inputs.k8s-cluster }}
      - id: get-version
        uses: cloudbees-io/get-artifact-details@v1
        with:
          artifact-id: ${{ inputs.artifact-id }}
      - name: Abort rollout
        uses: docker://020229604682.dkr.ecr.us-east-1.amazonaws.com/actions/helm-install-action:e7ba2d12beccee417aad45b6aa50966b7b5c8c06
        run: |
          set -u
          kubectl-argo-rollouts abort ${{ inputs.helm-release }}-canary-demo -n ${{ inputs.k8s-namespace }}
      - name: Watch rollout
        id: rollout
        env:
          JWT: ${{ cloudbees.api.token }}
          CB_API_URL: ${{ cloudbees.api.url }}
          CB_RUN_ID: ${{ cloudbees.run_id }}
          CB_RUN_ATTEMPT: ${{ cloudbees.run_attempt }}
          ENVIRONMENT: ${{ inputs.environment }}
          DEBUG: "true"
        uses: docker://alpine/k8s:1.32.11
        run: |
          set -u

          function register_deployment() {
            local artifact_id="$1" 
            local command_failed=0

            PAYLOAD=$(jq --null-input \
            --arg artifact_id "$artifact_id" \
            --arg runId "$CB_RUN_ID" \
            --arg runAttempt "$CB_RUN_ATTEMPT" \
            --arg environment "$ENVIRONMENT" \
            '{"runId": $runId, "runAttempt": $runAttempt, "artifact_id": $artifact_id, "environment": $environment}')

            response=$(curl --silent --show-error --fail-with-body  -X 'POST' "$CB_API_URL/v3/deployments" \
              -H "Authorization: Bearer $JWT" \
              -H 'Content-Type: application/json' \
              -d "$PAYLOAD") || command_failed=1

            if [ ${command_failed:-0} -eq 1 ];
            then
              echo "Failed to add deployment for artifact_id: $artifact_id, error: '$response'"
            fi  
          }

          function publish_evidence() {
            local evidence=$1
            local command_failed=0

            PAYLOAD=$(jq --null-input \
            --arg evidence "$evidence" \
            --arg runId "$CB_RUN_ID" \
            --arg runAttempt "$CB_RUN_ATTEMPT" \
            '{"runId": $runId, "runAttempt": $runAttempt, "evidence": {"format": "MARKDOWN", "value": $evidence}}')

            response=$(curl --retry 5 --retry-delay 10 --retry-all-errors --silent --show-error --fail-with-body \
              -X 'POST' "$CB_API_URL/v1/workflows/artifact" \
              -H "Authorization: Bearer $JWT" \
              -H 'Content-Type: application/json' \
              -d "$PAYLOAD") || command_failed=1

            if [ ${command_failed:-0} -eq 1 ];
            then
              echo "Failed to publish workflow evidence, error: '$response'"
            fi
          }

          progressing=true
          status=""
          previous_status=""
          rollout_output=""

          while $progressing; do
            sleep 10
            rollout_output="$(kubectl get rollout ${{ inputs.helm-release }}-canary-demo -n ${{ inputs.k8s-namespace }} -o json)"
            status="$(echo "$rollout_output" | jq -r '.status.phase')"

            total_replicas="$(echo "$rollout_output" | jq -r '.spec.replicas')"
            canary_replicas="$(echo "$rollout_output" | jq -r '.status.updatedReplicas')"
            
            echo "Status: $status"  
            if [ "$DEBUG" = "true" ]; then
                echo "Rollout output: $rollout_output"
            fi

            if [[ "$status" == "Healthy" ]]; then
              progressing=false
            elif [[ "$status" == "Degraded" ]]; then
              progressing=false                              
            fi

            if [[ "$status" != "$previous_status" ]]; then
              publish_evidence "Aborting rollout for version: ${{ steps.get-version.outputs.version }}, Deployment status: $status"     
            fi
            
            previous_status="$status"

          done
 
          publish_evidence "ðŸ”„ Version: ${{ steps.get-version.outputs.version }} rolled back"
          echo "ðŸ”„ Version: ${{ steps.get-version.outputs.version }} rolled back"
          echo "$rollout_output"
          exit -1  
          
  
